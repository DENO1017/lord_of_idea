# 《灵感之主》架构与技术选型指南

本文档为项目设定架构框架与技术选型原则，与 [项目概览](project_overview.md) 中的功能模块对应，便于后续设计与实现时保持一致。

---

## 1. 总体架构原则

- **分层清晰**：表现层、业务层、数据层职责分离，便于测试与替换实现。
- **功能内聚**：按「占卜/骰子/诗签」「电子手帐」「共享手帐与跑团」等业务域组织代码，避免大而全的单体模块。
- **可扩展**：新占卜方式、新装饰类型、新权限规则等应以可插拔方式扩展，而非硬编码。
- **跨平台一致**：Flutter 统一 UI 与业务逻辑，平台差异通过抽象接口隔离（如本地存储、推送、分享）。

---

## 2. 应用架构模式

推荐采用 **「按功能分模块 + 分层」** 的混合结构：

```
┌─────────────────────────────────────────────────────────┐
│                    表现层 (Presentation)                  │
│   screens / pages, widgets, 路由, 主题/国际化               │
├─────────────────────────────────────────────────────────┤
│                    业务层 (Domain / Application)          │
│   用例、领域模型、状态管理、权限与协作逻辑                   │
├─────────────────────────────────────────────────────────┤
│                    数据层 (Data)                          │
│   本地存储、远程 API、同步、缓存、Repository 实现           │
└─────────────────────────────────────────────────────────┘
```

- **表现层**：只关心 UI 与用户输入，通过 ViewModel / Controller 或状态管理与业务层通信。
- **业务层**：不依赖具体 UI 或具体存储实现，包含领域实体、用例、以及「谁可以看哪段内容」等规则。
- **数据层**：实现 Repository 接口，负责 SQLite/文件/远程 API/实时同步等，对上层暴露统一的数据访问抽象。

---

## 3. 项目目录结构建议

在 `lib/` 下按「功能模块 + 横切分层」组织，便于定位与扩展：

```
lib/
├── main.dart
├── app.dart                    # 应用入口、主题、路由注册
├── core/                       # 横切能力
│   ├── di/                     # 依赖注入
│   ├── router/                 # 路由与深链
│   ├── theme/
│   ├── l10n/
│   └── utils/
├── features/
│   ├── divination/             # 占卜与随机工具（塔罗、骰子、诗签）
│   │   ├── data/
│   │   ├── domain/
│   │   └── presentation/
│   ├── journal/                # 电子手帐（编辑、装饰、插入结果）
│   │   ├── data/
│   │   ├── domain/
│   │   └── presentation/
│   └── shared_journal/         # 共享手帐、跑团模板、权限
│       ├── data/
│       ├── domain/
│       └── presentation/
└── shared/                     # 跨功能共享
    ├── models/                 # 手帐、页面、块、装饰等通用模型
    ├── widgets/                # 通用 UI 组件
    └── services/               # 通用服务（如加密、导出）
```

- 每个 `feature` 内可再按 `data / domain / presentation` 划分子目录。
- 手帐的「页面、块、占卜结果块、骰子块、装饰」等模型若被多处使用，放在 `shared/models` 或 `shared/` 下。

---

## 4. 技术选型框架

以下为各技术点的选型范围与决策原则，具体采用哪一方案可在实现前在本文档或单独 ADR 中记录。

### 4.1 状态管理

| 方向 | 可选方案 | 适用场景 |
|------|----------|----------|
| 响应式/单向数据流 | Riverpod、Bloc、Provider | 全局/功能级状态、手帐编辑状态、权限状态 |
| 本地表单/复杂编辑 | 在现有状态管理上封装，或考虑 Notifier + 不可变模型 | 手帐富文本、装饰拖拽、块顺序 |

**建议**：优先选用 **Riverpod** 或 **Bloc** 之一并统一用到底；手帐编辑可拆为「当前页/当前选中的块」等粒度，避免单一大状态树。

### 4.2 本地存储与离线

| 需求 | 可选方案 | 说明 |
|------|----------|------|
| 结构化数据（手帐、页面、块、用户设置） | SQLite（drift / sqflite）、Isar、Hive | 需查询、关系、迁移时优先 SQLite/drift |
| 键值/简单配置 | shared_preferences、Hive | 主题、语言、上次打开的手帐 ID 等 |
| 文件与媒体 | path_provider + 文件系统、或封装为 Repository | 贴纸图片、导出 PDF、备份 |

**建议**：手帐与共享手帐内容建议用 **关系型（如 drift）** 建模，便于「按手帐/按页/按权限」查询；键值用 shared_preferences 即可。

### 4.3 网络与同步（共享手帐）

| 需求 | 可选方案 | 说明 |
|------|----------|------|
| 后端与 API | 自建服务（REST/GraphQL）、Firebase、Supabase 等 | 需考虑认证、权限、离线冲突 |
| 实时协作 | WebSocket、Firebase Realtime DB、Supabase Realtime、CRDT（如 Yjs） | 共享手帐多人编辑与权限可见性 |
| 认证 | Firebase Auth、自建 JWT、OAuth | 与后端选型一致 |

**建议**：先定义「手帐、块、权限」的数据模型与接口契约；若采用 Supabase/Firebase，可在架构上预留 **SyncService** 与 **ConflictResolution** 扩展点，便于后续做离线优先与冲突合并。

### 4.4 路由与导航

| 方向 | 可选方案 | 说明 |
|------|----------|------|
| 声明式路由 | go_router（推荐）、auto_route | 深链、权限重定向、嵌套路由（手帐内页/块） |
| 简单栈 | Navigator 2.0 + 自封装 | 体量小可接受，后期可迁到 go_router |

**建议**：统一使用 **go_router**，路径规划时考虑 `/journal/:id`、`/journal/:id/page/:pageId`、`/shared-journal/:id` 等，便于权限与分享链接。

### 4.5 依赖注入

| 方向 | 可选方案 | 说明 |
|------|----------|------|
| 与状态管理结合 | Riverpod（Provider） | 天然 DI，推荐与 Riverpod 状态管理一起用 |
| 独立 DI | get_it + injectable | 需要时再引入，避免与状态管理重复 |

**建议**：若采用 Riverpod，直接使用 **Riverpod 作为 DI 与状态管理** 的统一方案；Repository、API、本地 DB 均通过 Provider 暴露。

### 4.6 UI 与富文本（手帐）

| 需求 | 可选方案 | 说明 |
|------|----------|------|
| 富文本/块编辑 | flutter_quill、super_editor、自定义 InlineSpan | 插入占卜结果、骰子结果为「块」或内联节点 |
| 贴纸/胶带/装饰 | CustomPainter、Overlay、或富文本自定义块 | 需支持拖拽、层级、与块关联的元数据 |
| 主题与风格 | Material 3、自定义 ThemeData、多主题 | 与 project_overview 中「手帐美观」一致 |

**建议**：先确定手帐的「块模型」（文本块、占卜结果块、骰子块、装饰块），再选富文本或自绘方案；装饰可建模为「块级附件」或「层」，便于权限与导出。

### 4.7 测试

| 层级 | 建议 |
|------|------|
| 单元测试 | 业务逻辑、权限规则、占卜/骰子算法、数据转换 |
| Widget 测试 | 关键页面与组件（手帐列表、块编辑器、权限提示） |
| 集成测试 | 关键路径：创建手帐 → 插入结果 → 共享与权限 |

**建议**：Repository 与 Sync 层使用接口 + Mock，便于在无后端情况下跑通业务逻辑与权限测试。

---

## 5. 与功能模块的映射

| 功能模块（见 project_overview） | 架构要点 |
|--------------------------------|----------|
| 占卜与随机工具 | 独立 feature，算法与规则放在 domain；结果可序列化为「块」插入手帐。 |
| 电子手帐 | 核心 feature，数据层需支持手帐/页/块/装饰的 CRUD 与迁移；表现层需考虑富文本与装饰的协同。 |
| 共享手帐与跑团 | 独立 feature，依赖「手帐 + 块」模型；权限与可见性在 domain 层统一实现，数据层负责同步与按权限过滤。 |

---

## 6. 安全与隐私原则

- **本地数据**：敏感内容（如仅主持人可见的暗骰、背景设定）若仅存本地，需考虑设备加密或可选的应用锁。
- **同步与权限**：服务端需按「手帐持有者 + 块级/页级权限」校验，不信任客户端上送的可见性标记；客户端根据下发的权限过滤展示与编辑能力。
- **最小权限**：共享手帐的协作者默认仅获得「可写可见区」的权限，不可见区由持有者单独控制。

---

## 7. 文档与决策记录

- 本文档作为 **架构与技术选型的框架**，具体选型结果（如最终采用的 state / DB / 后端）可在本文档内更新表格，或使用 `docs/project/adr/` 下的 ADR（Architecture Decision Record）记录重要决策与原因。
- 与 [project_overview.md](project_overview.md) 保持一致：新增功能模块时，在此补充目录结构建议与选型考量。

---

*最后更新：架构框架初版，随技术选型落地可增补具体方案与 ADR 引用。*
