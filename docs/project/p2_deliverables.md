# P2 手帐核心：交付清单与文档索引

本文档对应 [project_manager](project_manager.md) 中的 **P2：手帐核心**，列出每项交付内容、验收标准、相关文档位置，以及**需要产品填写或决策的内容**。

---

## 交付项与文档映射

| P2 交付项 | 验收标准 | 对应文档 | 需填写/决策项 |
|-----------|----------|----------|----------------|
| 数据模型 | 手帐、页面、块（含类型 text/dice/poem_slip/divination）本地 DB 建模与迁移；可持久化并按手帐/页查询 | [手帐数据模型规格](../technical/journal_data_models_spec.md) | ✅ 已定稿 |
| 手帐 CRUD | 创建/重命名/删除手帐，增删页，页内块顺序可管理 | [手帐数据模型规格](../technical/journal_data_models_spec.md)、本文档 § 手帐 CRUD | ✅ 已定稿 |
| 块编辑 | 添加文本块；手帐编辑态工具栏调用工具并插入结果块；块可排序 | [手帐数据模型规格](../technical/journal_data_models_spec.md)、[工具结果模型](../technical/tool_result_models_spec.md) | ✅ 已定稿 |
| 基础展示 | 手帐阅读视图：按页展示块列表，不同块类型不同展示方式 | 本文档 § 基础展示 | ✅ 已定稿 |
| 路由与导航 | `/journal`、`/journal/:id`、`/journal/:id/page/:pageId` 可深链打开 | [路由规格](../technical/routes_spec.md) | 技术已约定，无 |

**任务拆解与测试用例**：见 [P2 开发任务拆解与测试用例](../development/p2_tasks_and_tests.md)。

---

## 需要产品填写的内容汇总（填写状态）

以下为 P2 中**与产品设计、体验、文案相关**的项；**已全部定稿**，实现时按本节约定落实。

### 手帐与页面命名 — ✅ 已定稿

- **手帐默认标题**：l10n key **`journalDefaultTitle`**，默认文案 **「未命名手账」**。新建手帐时若用户未输入标题则使用该文案（或先弹输入框，见 § 手帐 CRUD 交互细节）。
- **页面默认展示**：无自定义页标题时，页签/面包屑采用 **「N/Sum」** 形式，表示「当前第 N 页 / 共 Sum 页」。例如 `7/10` 表示共 10 页、当前第 7 页。N 与 Sum 均为 1-based 展示。

**落实**：l10n 中配置 `journalDefaultTitle`；页签展示逻辑中根据当前页 orderIndex+1 与总页数生成 `$current/$total` 字符串。

---

### 手帐列表展示 — ✅ 已定稿

- **列表形式**：使用 **卡片网格**（Card Grid）展示手帐列表。
- **列表范围**：**本地手账**与**共享手账**均在手账页内展示（不区分 tab；具体筛选/标签方式可按实现需要扩展）。
- **排序**：按**时间顺序**排布（如按最后修改时间或创建时间倒序，具体字段以数据模型为准）。
- **每项展示信息**：每张卡片展示 **封面** 与 **标题**。
- **空状态**：无手帐时仅展示按钮 **「创建手账」**，l10n key **`createJournal`**（不展示长段占位文案）。

**落实**：`JournalListScreen` 使用 GridView（或等价网格布局），数据含本地+共享手帐、按时间排序，每项为卡片含封面图与标题；空状态仅显示带 `createJournal` 文案的按钮。主壳与手账页签见 [主壳规格](../design/main_shell_spec.md)。

---

### 「插入到当前手帐」入口与流程 — ✅ 已定稿

- **入口位置**：仅在 **手帐编辑模式** 下提供插入工具结果的入口。  
  - **横版**：在 **右侧** 出现工具栏，其中有对应按钮可调用各工具（骰子/诗签/占卜）。  
  - **竖版**：在 **上侧** 出现工具栏，同上。  
  - 工具栏支持两种方式插入：(1) **从工具历史** 选择已有结果插入；(2) **现场使用工具**（弹窗或内联调用工具）得到结果后直接插入。
- **工具的单独入口**：从首页/工具聚合页进入的骰子、诗签、占卜 **独立工具页** 中，**暂不支持**「插入到特定手帐」功能；插入能力仅在手帐编辑态工具栏内提供。

**落实**：`JournalDetailScreen` 在编辑模式下根据横/竖屏显示右侧或上侧工具栏，工具栏内提供骰子/诗签/占卜入口，支持历史选择与现场调用并插入当前页；独立工具页（如 `/tools/dice`）不提供插入手帐按钮。

---

### 手帐内块的基础展示样式 — ✅ 已定稿

- **文本块**：技术默认——单段纯文本，与正文段落一致。
- **骰子块**：技术默认——与 [dice_spec](../technical/dice_spec.md) 一致：表达式 + total，可选展示 rolls。
- **诗签块**：技术默认——展示 content 全文。
- **占卜块**：**仅展示牌图**，正逆位展示正确（逆位时牌图旋转或使用逆位图）。
- **空页/空手帐**：**不显示占位文案**；空页时该区域留空，无「此页暂无内容」等提示。

**落实**：阅读视图中 divination 块只渲染牌图（正逆正确）；文本/骰子/诗签块按技术默认实现；空页不渲染占位文案。

---

### 手帐 CRUD 交互细节 — ✅ 已定稿

- **创建手帐**：从列表页点击「创建手帐」后，**先弹输入框让用户输入标题**，确认后再创建手帐并进入该手帐首页。若用户未输入则使用默认标题（l10n `journalDefaultTitle`，如「未命名手账」）。
- **删除手帐**：技术默认——删除前弹确认对话框，文案 l10n key `journalDeleteConfirm`（如「确定删除该手帐？此操作不可恢复。」）。
- **增删页**：技术默认——页签栏提供「添加页」；长按页签或页内菜单提供「删除页」与确认。
- **块顺序**：技术默认——支持长按拖拽排序；可选提供「上移/下移」按钮。

**落实**：创建手帐流程为先弹对话框输入标题再调用 createJournal；删除/增删页/块顺序按技术默认实现。

---

## P2 完成检查

- [x] 数据模型：手帐、页面、块（text/dice/poem_slip/divination）已在本地 DB（drift）建模并可迁移；支持按手帐/页查询。
- [x] 手帐 CRUD：可创建/重命名/删除手帐，可增删页，页内块顺序可管理。
- [x] 块编辑：可添加文本块；手帐编辑态工具栏可调用工具（含历史选择与现场使用）并插入结果块；块可排序。
- [x] 基础展示：手帐阅读视图按页展示块列表，各块类型有对应展示方式。
- [x] 路由与导航：`/journal`、`/journal/:id`、`/journal/:id/page/:pageId` 可深链打开；无效 id 重定向到 `/journal`。
- [x] 所有「需产品填写」项已在本文档落实并定稿。

---

## 与 P1 的衔接

- P1 的 `DiceResult`、`PoemSlipResult`、`DivinationResult` 的 `toJson()` 直接作为块的 `payload` 存储；块 `type` 取 `dice`、`poem_slip`、`divination`。见 [tool_result_models_spec](../technical/tool_result_models_spec.md#6-与手帐块block的对应关系p2-参考) 与 [journal_data_models_spec](../technical/journal_data_models_spec.md#7-与-p1-工具结果的转换)。

---

*本文档随 P2 推进更新勾选与需填写汇总。*
