# 骰子功能规格（P1）

本文档约定 P1 阶段「骰子」工具的行为、表达式语法与验收标准，与 [project_manager P1](../project/project_manager.md)、[工具结果模型](tool_result_models_spec.md) 一致。

---

## 1. 功能目标

- 用户可掷多颗骰子，**仅支持标准面数**（d4/d6/d8/d10/d12/d20），**不支持自定义面数骰子**。
- 支持表达式（如 `2d6+3`），掷骰后展示结果并可序列化为 [DiceResult](tool_result_models_spec.md#3-骰子结果diceresult)。
- 本阶段不要求登录与网络，全部本地完成。

---

## 2. 支持的骰子类型

| 标识 | 面数 | 说明 |
|------|------|------|
| d4 | 4 | 常见桌游 |
| d6 | 6 | 常见桌游 |
| d8 | 8 | 常见桌游 |
| d10 | 10 | 常见桌游 |
| d12 | 12 | 常见桌游 |
| d20 | 20 | 常见桌游/跑团 |

**P1 不在 UI 上提供自定义面数输入**；仅支持上述标准骰子。常见组合（如 d100）通过「两颗 d10」等方式在快捷或骰子盘中组合实现。

---

## 3. 表达式语法

- **格式**：`[数量]d[面数][加减修正]`（**P1 仅支持单组**，即一个 NdX+M）。
  - 数量：正整数，省略时视为 1；**最大数量**：20（与 [tool_result_models_spec](tool_result_models_spec.md) 一致）。
  - 面数：仅允许 4、6、8、10、12、20（标准骰子）。
  - 加减修正：`+N` 或 `-N`，可选；**N 范围**：-999～+999。
- **合法示例**：`d6`、`2d6`、`1d20+5`、`4d6-2`；d100 用 `2d10` 等组合表示。
- **非法示例**：`d`、`0d6`、`2d0`、`2d6+3d8`（多组骰子 P1 不支持）、`d7`（非标准面数）。

**解析与校验**：解析失败时通过**弹框**展示原因；**l10n key**：`INVALID_DICE`。

---

## 4. 随机源与可测试性

- 掷骰结果应使用可注入的随机源（如 `Random` 或封装为 `DiceRoller` 接受 `Random` 入参），便于单测中替换为固定种子。
- **实现位置**：`features/divination/domain/services/dice_roller.dart`（或 `dice_service.dart`）；若使用 Riverpod，可提供 `diceRollerProvider`，内部使用 `Random()`，测试时 override 为 `Random(seed)`。

---

## 5. UI 与交互

### 5.1 入口与布局

- **入口**：从「工具」页进入骰子子页；**路由**：`/tools/dice`，**Screen**：`DiceScreen`（见 [routes_spec](routes_spec.md)）。
- **界面上方**：展示当前组合的表达式（随骰子盘内容实时更新）。

### 5.2 快捷投掷

- **快捷按钮**：在 UI 上提供快捷按钮，支持：
  - **单颗骰子**：d4、d6、d8、d10、d12、d20 各一颗，点击即掷。
  - **常见组合**：如 d100（投两颗 d10 计算，即 2d10）、其他产品约定的组合；仅使用标准骰子组合，无自定义面数。

### 5.3 自定义组合骰子（骰子盘）

- **添加骰子**：点击支持的标准单颗骰子（d4/d6/d8/d10/d12/d20）后，将该骰子加入**骰子盘**。
- **加减修正（珠子）**：修正值用珠子的**颜色**与**大小**表示：
  - **颜色**：红色表示正修正，黑色表示负修正。
  - **大小**：小、中、大三种，分别对应数值 **1**、**5**、**10**（正负由颜色决定）。
  - 例如：小红珠 = +1，中红珠 = +5，大红珠 = +10；小黑珠 = -1，中黑珠 = -5，大黑珠 = -10。
- **移除**：在骰子盘中点击某颗骰子或某个珠子，可将该骰子/珠子从骰子盘移出。
- **数量**：每种骰子与每种珠子的数量通过**可上下滑动的滑块**在界面上调整；表达式区域可联动，支持在表达式中快速调整对应数量。
- **数量限制**：骰子与珠子的**最大数量均为 20**；当前组合的表达式实时显示在界面上方。
- **确定投掷**：确定好骰子盘内容后，点击「确定」按钮执行投骰。
  - 当**数量为 0** 或**数量超过上限（20）**时，「确定」按钮**不可用**。
  - 若用户在不可用状态下点击，**弹框提示错误原因**（如「数量不能为 0」或「数量不能超过 20」）。

### 5.4 掷骰结果与操作

- **结果展示**：展示 total、各颗骰子点数（rolls）、expression。
- **三个操作按钮**：
  - **舍弃**：丢弃本次结果，不写入历史（或按 §5.5 规则仅保留最近一次可舍弃/重投记录）。
  - **重 Roll**：用同一表达式再掷一次，不保存当前结果（或按 §5.5 规则处理）。
  - **保存并复制**：将本次结果写入会话历史，并复制到剪贴板。
- **复制内容**：复制时复制**完整表达式 + 总和**；**不包含**各颗骰子的 rolls 明细，只记录总和。格式：**无空格**，使用等号连接，例如 `3d6+3=7`。

### 5.5 会话内投掷历史

- **支持**：P1 支持本次会话内的掷骰历史列表。
- **最大条数**：100 条。
- **舍弃/重 Roll 的保存规则**：舍弃或重 Roll 的只保存**最近的一次**记录（便于在历史中编辑或再次操作）；可在历史中将其**编辑为保存**，即转为正式历史条目。
- **再次复制**：会话内历史支持对某条记录再次复制（复制格式同 §5.4：无空格，表达式+等号+总和，如 `3d6+3=7`）。

---

## 6. 验收标准（与 project_manager 对齐）

- 可掷 d4/d6/d8/d10/d12/d20，**不支持自定义面数**；支持快捷单颗与常见组合（如 d100 用 2d10）。
- 骰子盘支持通过点击添加/移除标准骰子与珠子（加减修正），数量滑块与表达式联动，数量 0 或超限时确定按钮不可用并弹框提示。
- 掷骰后展示结果，并提供舍弃、重 Roll、保存并复制；复制内容为完整表达式 + 总和（不含 rolls 明细），格式无空格、等号连接（如 `3d6+3=7`）。
- 表达式解析失败时弹框提示，l10n key 为 `INVALID_DICE`。
- 会话内历史最多 100 条，舍弃/重 Roll 仅保留最近一次，可编辑为保存；历史支持再次复制。
- 结果结构可序列化为 [DiceResult](tool_result_models_spec.md#3-骰子结果diceresult) 且含 `toJson()`/`fromJson()`。
- 表达式非法时有不误导用户的错误提示。

---

## 7. 需填写/实现约定（可选）

- 无；解析失败（§3）与复制格式（§5.4）已约定。

---

*对应 [p1_deliverables](../project/p1_deliverables.md) 中「骰子」项。*
