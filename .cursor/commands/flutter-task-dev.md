# Flutter 按任务编号开发

根据用户提供的 **任务编号**（如 `P0-1`、`P1-2`）或 **修复单编号**（如 `B-P1-1-001`）完成开发：查找任务/修复需求 → 实现 → 编写/补全测试 → 代码自检与运行测试。优先使用 Dart/Flutter MCP 工具（user-dart）。

**支持的输入格式**：

| 格式 | 说明 | 示例 |
|------|------|------|
| 任务编号 | **P\<阶段\>-\<任务\>**，阶段内任务号 | `P0-1`、`P1-2`、`P2-3` |
| 修复单编号 | **B\<阶段\>-\<开发号\>-\<Bug序号\>**，三位 Bug 流水号 | `B-P1-1-001`、`B-P1-1-002` |

---

## 0. 识别输入类型并分支

- **修复单格式**：以 `B-` 开头，且符合 `B-P{n}-{m}-{三位数}`（如 `B-P1-1-001`）。→ 执行 **流程 A：修复单开发**（下文第 A 节）。
- **任务编号格式**：符合 `P\<阶段\>-\<任务\>`（如 `P0-1`、`P1-2`）。→ 执行 **流程 B：任务开发**（下文第 1～6 节）。
- 若无法解析或未输入，主动询问：「请提供任务编号（如 P0-1、P1-2）或修复单编号（如 B-P1-1-001）。」

---

# 流程 A：修复单开发（输入为 B-xxx-xxx-xxx）

## A1. 解析修复单编号

- 从用户输入解析：**阶段**（如 P1）、**开发号**（如 1）、**Bug 序号**（如 001）。
- 正则示例：`B-P(\d+)-(\d+)-(\d{3})`，对应 `B-P1-1-001` → 阶段 P1、开发号 1、序号 001。

## A2. 在修复单文档中查找

- **文档路径**：`docs/qa/bug_fix_list.md`。
- 在文档中定位以 **「### B-\<阶段\>-\<开发号\>-\<序号\>」** 开头的章节（与用户输入完全一致），例如 `### B-P1-1-001`。
- 阅读该修复单表格中的：**标题**、**现象描述**、**复现步骤**、**预期**、**关联测试项**、**状态**。
- 若未找到对应章节，告知用户：「修复单文档中未找到该编号（如 B-P1-1-001），请确认编号或先在 bug_fix_list.md 中录入。」

## A3. 更新状态为「修复中」

- 在 `docs/qa/bug_fix_list.md` 中，将该修复单表格里的 **状态** 从「待修复」改为 **「修复中」**（若已是修复中则保持不变），保存文档。

## A4. 实现修复

- 根据该修复单的 **现象描述**、**复现步骤**、**预期** 确定修改范围（涉及的路由、组件、状态或文案）。
- 遵循项目约定：`docs/development/code_structure.md`、`docs/technical/` 下相关规范；涉及主题或 l10n 时参考 `docs/design/theme_spec.md`、`docs/technical/settings_and_l10n_spec.md`。
- 实现代码修改，使行为符合「预期」；若有关联测试项（如 P1-11），可对照 `docs/qa/app_manual_test_checklist.md` 中对应条目补充或修改自动化/集成测试。

## A5. 编写或补全测试

- 按修复单 **关联测试项**（若有）或根据复现步骤，在合适位置补充 Unit/Widget/Integration 测试（如 `test/`、`integration_test/`），确保修复场景可被自动化覆盖。
- 若文档中已指明测试文件建议，优先在该路径补全用例。

## A6. 代码自检与测试

按「修改代码后自检」工作流执行（与 `/flutter-post-edit-check` 一致），全部使用 MCP：

1. **add_roots** — 若尚未添加，添加当前项目根。
2. **dart_format** — 对项目根执行格式化（`lib/`、`test/`）。
3. **analyze_files** — 分析本次修改涉及路径或整个项目。
4. **dart_fix** — 若有可自动修复项，对项目根执行一次。
5. **run_tests** — 使用 MCP 的 run_tests。

任一步失败则修复后从该步重新执行，直至全部通过。

## A7. 更新修复单状态并收尾

- 在 `docs/qa/bug_fix_list.md` 中，将该修复单的 **状态** 更新为 **「待验证」**（开发已完成，待 QA 复测）；若产品决定不修或已确认关闭，可更新为 **「已关闭」**。
- 可选：在文档末尾「修订记录」中追加一行，如：`| 日期 | 修订内容 |`、`| 2026-02-23 | B-P1-1-001 开发完成，状态更新为待验证。 |`
- 向用户简要汇报：修复单编号、完成项（修改点 + 测试）、自检与测试结果、文档状态更新情况。

---

# 流程 B：任务开发（输入为 Px-x）

## 1. 解析任务编号

- 用户会输入任务编号，格式为 **P\<阶段\>-\<任务\>**，例如：`P0-1`、`P1-2`、`P2-3`。
- 解析出 **阶段**（phase，如 0、1、2）与 **任务号**（task，如 1、2、3）。
- 若用户未输入或格式无法解析（如缺少 `P`、没有 `-`），主动询问：「请提供任务编号，例如 P0-1 或 P1-2」。

---

## 2. 查找任务内容

- **任务文档路径**：按阶段对应文件 `docs/development/p\<阶段\>_tasks_and_tests.md`。  
  - 例如：P0-1 → `docs/development/p0_tasks_and_tests.md`；P1-2 → `docs/development/p1_tasks_and_tests.md`；P2-3 → `docs/development/p2_tasks_and_tests.md`。
- 若该文件不存在，告知用户：「阶段 P\<阶段\> 的任务文档尚未创建（缺少 `docs/development/p\<阶段\>_tasks_and_tests.md`）」，并停止后续步骤。
- 在对应文档中定位以 **「## P\<阶段\>-\<任务\>：」** 开头的章节（与用户输入完全一致），例如 `## P1-2：`、`## P2-3：`。
- 阅读该章节中的：
  - **开发内容**：要实现的代码与文件位置。
  - **验收**：完成标准。
  - **对应测试用例**：表格中的编号、类型（Unit/Widget/Integration）、描述、断言/步骤。
- 文档开头的「任务与测试索引」表可用来确认该任务的概要与建议测试文件路径（如 `test/app_test.dart`、`test/core/theme/app_theme_test.dart`）。

---

## 3. 实现开发内容

- 严格按「开发内容」与项目约定实现，遵循：
  - `docs/development/code_structure.md`（目录、命名）；
  - `docs/technical/routes_spec.md`、`docs/technical/state_and_di_spec.md`、`docs/technical/settings_and_l10n_spec.md` 等（若任务涉及）。
- 涉及主题时参考 `docs/design/theme_spec.md`（若存在）。
- 新建或修改的文件放在文档与 code_structure 约定的路径下；命名：文件 snake_case，类 PascalCase。

---

## 4. 编写或补全测试

- 按该任务「对应测试用例」表格逐条落实：
  - 将用例落到「测试文件建议」列给出的路径（如 `test/core/theme/app_theme_test.dart`）；
  - Unit 测试：断言与步骤按表格描述编写；
  - Widget 测试：pumpWidget / pumpApp、find、expect 按表格执行；
  - Integration 测试：按文档说明放在 `integration_test/` 并实现步骤。
- 若测试文件不存在则创建；若已存在则补充或修改用例，确保表格中列出的用例均有对应测试并通过。

---

## 5. 代码自检与测试

按「修改代码后自检」工作流执行（与 `/flutter-post-edit-check` 一致），全部使用 MCP：

1. **add_roots** — 若尚未添加，添加当前项目根。
2. **dart_format** — 对项目根执行格式化（`lib/`、`test/`）。
3. **analyze_files** — 分析本次修改涉及路径或整个项目。
4. **dart_fix** — 若有可自动修复项，对项目根执行一次。
5. **run_tests** — 使用 MCP 的 run_tests，不执行 `flutter test` / `dart test`。

任一步失败则修复后从该步重新执行，直至全部通过。

---

## 6. 收尾

- 对照该任务的「验收」条款，确认均已满足。
- 向用户简要汇报：任务编号、完成项（实现 + 测试）、自检与测试结果（通过/失败及处理情况）。

**参考**：任务与测试细节以各阶段的 `docs/development/p{阶段}_tasks_and_tests.md`（如 p0、p1、p2）为准；修复单以 `docs/qa/bug_fix_list.md` 为准；自检流程见 `.cursor/skills/flutter-development/SKILL.md` 与 `.cursor/commands/flutter-post-edit-check.md`。
